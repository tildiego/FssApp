@page "/formations-sanitaires"

@rendermode InteractiveServer

@inject NavigationManager NavigationManager

@inject IGetFosasDtoUseCase ViewFosasDtoUseCase
@inject IGetFosaByIdUseCase GetFosaByIdUseCase
@inject IDeleteFosaByIdUseCase DeleteFosaByIdUseCase

<MudDataGrid T="FormationSanitaireDto" MultiSelection="true" Items="@Fosas" SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@quickFilter"
             Hideable="true" FixedHeader ShowMenuIcon Height="550px" RowClick="@RowClicked" RowContextMenuClick="@RowRightClicked" 
             SelectedItemsChanged="@SelectedItemsChanged">
    <ToolBarContent>
        <MudText Typo="Typo.h6">LISTE DES FORMATIONS SANITAIRES</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Recherche" Adornment="Adornment.Start" Immediate="true"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <Columns>
        @* <SelectColumn T="FormationSanitaireDto" /> *@
        <PropertyColumn Property="x => x.FosaId" Title="FOSA ID" />
        <PropertyColumn Property="x => x.Fosa" Title="Nom fosa" />
        <PropertyColumn Property="x => x.Province" Title="Province" SortBy="@sortBy" />
        <PropertyColumn Property="x => x.District" Title="District" />
        <PropertyColumn Property="x => x.ZoneDeSante" title="Zone santé" />
        <PropertyColumn Property="x => x.TypeFosa" Title="Type fosa" />
        <PropertyColumn Property="x => x.Adresse" />
        <PropertyColumn Property="x => x.Telephone" Title="Téléphone" />
        <PropertyColumn Property="x => x.ResponsableNom" Title="Nom responsable" />
        <PropertyColumn Property="x => x.ResponsablePostNom" Title="Postnom responsable" />
        <PropertyColumn Property="x => x.ResponsablePrenom" Title="Prénom responsable" />
        <PropertyColumn Property="x => x.ResponsableEmail" Title="Email responsable" />
        <PropertyColumn Property="x => x.ResponsableTelephone" Title="Téléphone responsable" />
        <PropertyColumn Property="x => x.FosaConventionnee" Title="Conventionnée" />
        <PropertyColumn Property="x => x.Statut" />
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate>
                <MudStack Row>
                    <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Success"
                                Href=@($"/editfosa/{context.Item.FosaId}")>Modifier</MudButton>
                    <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Warning"
                               OnClick="@(async () => await HandleDelete(context.Item.FosaId))">Supprimer</MudButton>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <div class="d-flex align-items-start">
            <MudDataGridPager T="FormationSanitaireDto" />
        </div>
    </PagerContent>
</MudDataGrid>

<div class="mt-4">
<MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/addfosa">Ajouter fosa</MudButton>
</div>

@* <div class="d-flex flex-wrap mt-4">
    <MudSwitch @bind-Value="@sortNameByLength" Color="Color.Primary">Sort Name Column By Length</MudSwitch>
</div>

<MudExpansionPanels Style="flex:1">
    <MudExpansionPanel Text="Show Events">
        @foreach (var message in events)
        {
            <MudText Typo="@Typo.body2">@message</MudText>
        }
        @if(events.Count > 0) 
        {
            <div class="d-flex">
                <MudSpacer/>
                <MudButton Class="mt-3" ButtonType="ButtonType.Button" Variant="Variant.Filled" OnClick="@(() => events.Clear())">Clear</MudButton>
            </div>
        }
    </MudExpansionPanel>
</MudExpansionPanels> *@

@code {
    [Inject] ISnackbar Snackbar { get; set; }

    private IEnumerable<FormationSanitaireDto> Fosas = new List<FormationSanitaireDto>();
    private string searchString;
    private bool sortNameByLength;
    private List<string> events = new(); 

    protected async override Task OnInitializedAsync()
    {
        Fosas = await GetAllFosaAsync();
    }

    private async Task<IEnumerable<FormationSanitaireDto>> GetAllFosaAsync()
    {
        return await ViewFosasDtoUseCase.ExecuteAsync();
    }

    public async Task HandleDelete(int fosaId)
    {
        var fosa = await GetFosaByIdUseCase.ExcuteAsync(fosaId);
        await DeleteFosaByIdUseCase.ExecuteAsync(fosaId);
        
        Snackbar.Add($"Formation sanitaire (ID : {fosaId} - Fosa : {fosa.Nom}) \n supprimée avec succès!", MudBlazor.Severity.Info);

        await Task.Delay(3000);
        NavigationManager.Refresh(true);
    }

    private Func<FormationSanitaireDto, object> sortBy => x =>
    {
        if (sortNameByLength)
            return x.Fosa.Length;
        else
            return x.Fosa;
    };

    private Func<FormationSanitaireDto, bool> quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (x.Province.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.District.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.ZoneDeSante.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Fosa.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    // events
    void RowClicked(DataGridRowClickEventArgs<FormationSanitaireDto> args)
    {
        events.Insert(0, $"Event = RowClick, Index = {args.RowIndex}, Data = {System.Text.Json.JsonSerializer.Serialize(args.Item)}");
    }

    void RowRightClicked(DataGridRowClickEventArgs<FormationSanitaireDto> args)
    {
        events.Insert(0, $"Event = RowRightClick, Index = {args.RowIndex}, Data = {System.Text.Json.JsonSerializer.Serialize(args.Item)}");
    }

    void SelectedItemsChanged(HashSet<FormationSanitaireDto> items)
    {
        events.Insert(0, $"Event = SelectedItemsChanged, Data = {System.Text.Json.JsonSerializer.Serialize(items)}");
    }
}
